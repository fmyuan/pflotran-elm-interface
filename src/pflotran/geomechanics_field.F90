module Geomechanics_Field_module

#include "petsc/finclude/petscmat.h"
  use petscmat
  use PFLOTRAN_Constants_module
! IMPORTANT NOTE: This module can have no dependencies on other modules!!!

  implicit none

  private

  type, public :: geomech_field_type
    Vec :: work
    Vec :: work_loc
    ! residual vectors
    Vec :: rhs
    Vec :: press          ! store pressure from subsurf
    Vec :: press_loc
    Vec :: press_init_loc ! store initial pressure
    Vec :: temp           ! store temperature from subsurf
    Vec :: temp_loc
    Vec :: temp_init_loc  ! store initial temperature
    Vec :: subsurf_vec_1dof ! MPI
    Vec :: imech_loc
    Vec :: strain
    Vec :: strain_loc
    Vec :: stress
    Vec :: stress_loc
    Vec :: stress_total
    Vec :: stress_total_loc
    Vec :: strain_subsurf  ! Stores strains after scattering from geomech to subsurf
    Vec :: stress_subsurf  ! Stores stresses after scattering from geomech to subsurf
    Vec :: strain_subsurf_loc
    Vec :: stress_subsurf_loc

    Vec :: porosity ! store porosity from subsurf
    Vec :: porosity_loc
    Vec :: porosity_init_loc

    ! spatially-varying material properties
    Vec :: youngs_modulus
    Vec :: poissons_ratio
    Vec :: density
    Vec :: biot_coeff
    Vec :: thermal_exp_coeff

    Vec :: fluid_density ! store density from subsurf
    Vec :: fluid_density_loc
    Vec :: fluid_density_init_loc

    ! Solution vectors (xx = current iterate)
    Vec :: disp_xx, disp_xx_loc
    Vec :: disp_xx_init_loc

    Mat :: A ! stores the matrix of the linear system

  end type geomech_field_type

  public :: GeomechFieldCreate, &
            GeomechFieldDestroy

contains

! ************************************************************************** !

function GeomechFieldCreate()
  !
  ! Allocates and initializes a new geomechanics
  ! Field object
  !
  ! Author: Satish Karra, LANL
  ! Date: 06/05/13
  !

  implicit none

  type(geomech_field_type), pointer :: GeomechFieldCreate
  type(geomech_field_type), pointer :: geomech_field

  allocate(geomech_field)

  ! nullify PetscVecs
  PetscObjectNullify(geomech_field%work)
  PetscObjectNullify(geomech_field%work_loc)

  PetscObjectNullify(geomech_field%rhs)
  PetscObjectNullify(geomech_field%disp_xx)
  PetscObjectNullify(geomech_field%disp_xx_loc)
  PetscObjectNullify(geomech_field%disp_xx_init_loc)

  PetscObjectNullify(geomech_field%press)
  PetscObjectNullify(geomech_field%press_loc)
  PetscObjectNullify(geomech_field%press_init_loc)
  PetscObjectNullify(geomech_field%temp)
  PetscObjectNullify(geomech_field%temp_loc)
  PetscObjectNullify(geomech_field%temp_init_loc)
  PetscObjectNullify(geomech_field%subsurf_vec_1dof)
  PetscObjectNullify(geomech_field%imech_loc)

  PetscObjectNullify(geomech_field%strain)
  PetscObjectNullify(geomech_field%strain_loc)
  PetscObjectNullify(geomech_field%stress)
  PetscObjectNullify(geomech_field%stress_loc)
  PetscObjectNullify(geomech_field%stress_total)
  PetscObjectNullify(geomech_field%stress_total_loc)

  PetscObjectNullify(geomech_field%strain_subsurf)
  PetscObjectNullify(geomech_field%stress_subsurf)
  PetscObjectNullify(geomech_field%strain_subsurf_loc)
  PetscObjectNullify(geomech_field%stress_subsurf_loc)

  PetscObjectNullify(geomech_field%porosity)
  PetscObjectNullify(geomech_field%porosity_loc)
  PetscObjectNullify(geomech_field%porosity_init_loc)

  PetscObjectNullify(geomech_field%youngs_modulus)
  PetscObjectNullify(geomech_field%poissons_ratio)
  PetscObjectNullify(geomech_field%density)
  PetscObjectNullify(geomech_field%biot_coeff)
  PetscObjectNullify(geomech_field%thermal_exp_coeff)

  PetscObjectNullify(geomech_field%fluid_density)
  PetscObjectNullify(geomech_field%fluid_density_loc)
  PetscObjectNullify(geomech_field%fluid_density_init_loc)

  PetscObjectNullify(geomech_field%A)

  GeomechFieldCreate => geomech_field

end function GeomechFieldCreate

! ************************************************************************** !

subroutine GeomechFieldDestroy(geomech_field)
  !
  ! Deallocates a geomechanics field object
  !
  ! Author: Satish Karra, LANL
  ! Date: 06/05/13
  !

  implicit none

  type(geomech_field_type), pointer :: geomech_field
  PetscErrorCode :: ierr

  if (.not.associated(geomech_field)) return

  ! Destroy PetscVecs
  if (.not.PetscObjectIsNull(geomech_field%work)) then
    call VecDestroy(geomech_field%work,ierr);CHKERRQ(ierr)
  endif
  if (.not.PetscObjectIsNull(geomech_field%work_loc)) then
    call VecDestroy(geomech_field%work_loc,ierr);CHKERRQ(ierr)
  endif

  if (.not.PetscObjectIsNull(geomech_field%rhs)) then
    call VecDestroy(geomech_field%rhs,ierr);CHKERRQ(ierr)
  endif
  if (.not.PetscObjectIsNull(geomech_field%disp_xx)) then
    call VecDestroy(geomech_field%disp_xx,ierr);CHKERRQ(ierr)
  endif
  if (.not.PetscObjectIsNull(geomech_field%disp_xx_loc)) then
    call VecDestroy(geomech_field%disp_xx_loc,ierr);CHKERRQ(ierr)
  endif
  if (.not.PetscObjectIsNull(geomech_field%disp_xx_init_loc)) then
    call VecDestroy(geomech_field%disp_xx_init_loc,ierr);CHKERRQ(ierr)
  endif

  if (.not.PetscObjectIsNull(geomech_field%press)) then
    call VecDestroy(geomech_field%press,ierr);CHKERRQ(ierr)
  endif
  if (.not.PetscObjectIsNull(geomech_field%press_loc)) then
    call VecDestroy(geomech_field%press_loc,ierr);CHKERRQ(ierr)
  endif
  if (.not.PetscObjectIsNull(geomech_field%press_init_loc)) then
    call VecDestroy(geomech_field%press_init_loc,ierr);CHKERRQ(ierr)
  endif
  if (.not.PetscObjectIsNull(geomech_field%temp)) then
    call VecDestroy(geomech_field%temp,ierr);CHKERRQ(ierr)
  endif
  if (.not.PetscObjectIsNull(geomech_field%temp_loc)) then
    call VecDestroy(geomech_field%temp_loc,ierr);CHKERRQ(ierr)
  endif
  if (.not.PetscObjectIsNull(geomech_field%temp_init_loc)) then
    call VecDestroy(geomech_field%temp_init_loc,ierr);CHKERRQ(ierr)
  endif

  if (.not.PetscObjectIsNull(geomech_field%subsurf_vec_1dof) ) then
    call VecDestroy(geomech_field%subsurf_vec_1dof,ierr);CHKERRQ(ierr)
  endif
  if (.not.PetscObjectIsNull(geomech_field%imech_loc)) then
    call VecDestroy(geomech_field%imech_loc,ierr);CHKERRQ(ierr)
  endif

  if (.not.PetscObjectIsNull(geomech_field%strain)) then
    call VecDestroy(geomech_field%strain,ierr);CHKERRQ(ierr)
  endif
  if (.not.PetscObjectIsNull(geomech_field%strain_loc)) then
    call VecDestroy(geomech_field%strain_loc,ierr);CHKERRQ(ierr)
  endif
  if (.not.PetscObjectIsNull(geomech_field%stress)) then
    call VecDestroy(geomech_field%stress,ierr);CHKERRQ(ierr)
  endif
  if (.not.PetscObjectIsNull(geomech_field%stress_loc)) then
    call VecDestroy(geomech_field%stress_loc,ierr);CHKERRQ(ierr)
  endif
  if (.not.PetscObjectIsNull(geomech_field%stress_total)) then
    call VecDestroy(geomech_field%stress_total,ierr);CHKERRQ(ierr)
  endif
  if (.not.PetscObjectIsNull(geomech_field%stress_total_loc)) then
    call VecDestroy(geomech_field%stress_total_loc,ierr);CHKERRQ(ierr)
  endif

  if (.not.PetscObjectIsNull(geomech_field%strain_subsurf)) then
    call VecDestroy(geomech_field%strain_subsurf,ierr);CHKERRQ(ierr)
  endif
  if (.not.PetscObjectIsNull(geomech_field%stress_subsurf)) then
    call VecDestroy(geomech_field%stress_subsurf,ierr);CHKERRQ(ierr)
  endif
  if (.not.PetscObjectIsNull(geomech_field%strain_subsurf_loc)) then
    call VecDestroy(geomech_field%strain_subsurf_loc,ierr);CHKERRQ(ierr)
  endif
  if (.not.PetscObjectIsNull(geomech_field%stress_subsurf_loc)) then
    call VecDestroy(geomech_field%stress_subsurf_loc,ierr);CHKERRQ(ierr)
  endif

  if (.not.PetscObjectIsNull(geomech_field%porosity)) then
    call VecDestroy(geomech_field%porosity,ierr);CHKERRQ(ierr)
  endif
  if (.not.PetscObjectIsNull(geomech_field%porosity_loc)) then
    call VecDestroy(geomech_field%porosity_loc,ierr);CHKERRQ(ierr)
  endif
  if (.not.PetscObjectIsNull(geomech_field%porosity_init_loc)) then
    call VecDestroy(geomech_field%porosity_init_loc,ierr);CHKERRQ(ierr)
  endif

  if (.not.PetscObjectIsNull(geomech_field%youngs_modulus)) then
    call VecDestroy(geomech_field%youngs_modulus,ierr);CHKERRQ(ierr)
  endif
  if (.not.PetscObjectIsNull(geomech_field%poissons_ratio)) then
    call VecDestroy(geomech_field%poissons_ratio,ierr);CHKERRQ(ierr)
  endif
  if (.not.PetscObjectIsNull(geomech_field%density)) then
    call VecDestroy(geomech_field%density,ierr);CHKERRQ(ierr)
  endif
  if (.not.PetscObjectIsNull(geomech_field%biot_coeff)) then
    call VecDestroy(geomech_field%biot_coeff,ierr);CHKERRQ(ierr)
  endif
  if (.not.PetscObjectIsNull(geomech_field%thermal_exp_coeff)) then
    call VecDestroy(geomech_field%thermal_exp_coeff,ierr);CHKERRQ(ierr)
  endif

  if (.not.PetscObjectIsNull(geomech_field%fluid_density)) then
    call VecDestroy(geomech_field%fluid_density,ierr);CHKERRQ(ierr)
  endif
  if (.not.PetscObjectIsNull(geomech_field%fluid_density_loc)) then
    call VecDestroy(geomech_field%fluid_density_loc,ierr);CHKERRQ(ierr)
  endif
  if (.not.PetscObjectIsNull(geomech_field%fluid_density_init_loc)) then
    call VecDestroy(geomech_field%fluid_density_init_loc,ierr);CHKERRQ(ierr)
  endif

  if (associated(geomech_field)) deallocate(geomech_field)
  nullify(geomech_field)

end subroutine GeomechFieldDestroy

end module Geomechanics_Field_module
